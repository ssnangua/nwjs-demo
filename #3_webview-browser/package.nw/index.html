<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>&lt;webview&gt; Demo</title>
    <style>
      html,
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-flow: column;
        font-size: 14px;
      }
      .title-bar,
      .address-bar,
      .find-bar {
        display: flex;
        flex-flow: row;
        align-items: center;
        padding: 5px 10px;
        background-color: #f7f7f7;
        border-bottom: 1px solid #ccc;
      }
      #favicon {
        width: 16px;
        height: 16px;
        margin-right: 4px;
      }
      #title {
        flex: auto;
      }
      #url {
        flex: auto;
      }
      .find-bar {
        justify-content: flex-end;
      }
      .content {
        flex: auto;
        display: flex;
        flex-flow: row;
      }
      #webview {
        flex: 2;
      }
      #devTools {
        flex: 1;
        border-left: 1px solid #ccc;
      }
      .hide {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="title-bar">
      <img id="favicon" src="" />
      <label id="title"></label>
    </div>
    <div class="address-bar">
      <button id="back">返回</button>
      <button id="forward">前进</button>
      <button id="reload">刷新</button>
      <button id="stop">停止</button>
      <input id="url" type="text" />
      <button id="toggleDevTools">开发者工具</button>
    </div>
    <div class="find-bar">
      <div>查找：</div>
      <input id="searchText" type="text" />
      <div id="matches">0/0</div>
      <button id="findPrev">上一个</button>
      <button id="findNext">下一个</button>
    </div>
    <div class="content">
      <webview id="webview" src="https://www.baidu.com"></webview>
      <webview id="devTools" src="about:blank" class=""></webview>
    </div>
    <script>
      const els = {};
      document.querySelectorAll("[id]").forEach((el) => (els["$" + el.id] = el));

      with (els) {
        // 在另一个webview中加载开发者工具
        $devTools.addEventListener("contentload", () => {
          $webview.showDevTools(true, $devTools);
        });

        $back.addEventListener("click", () => $webview.back());
        $forward.addEventListener("click", () => $webview.forward());
        $reload.addEventListener("click", () => $webview.reload());
        $stop.addEventListener("click", () => $webview.stop());
        $url.addEventListener("keydown", (e) => {
          if (!e.repeat && e.code === "Enter") {
            let url = $url.value.trim();
            if (!url.startsWith("http")) url = "https://" + url;
            $webview.src = url;
          }
        });
        $toggleDevTools.addEventListener("click", () => {
          const isShow = !$devTools.classList.contains("hide");
          $devTools.classList[isShow ? "add" : "remove"]("hide");
        });

        function find(backward) {
          $webview.find($searchText.value.trim(), { backward }, (results) => {
            $matches.textContent = `${results.activeMatchOrdinal}/${results.numberOfMatches}`;
          });
        }
        $findPrev.addEventListener("click", () => find(true));
        $findNext.addEventListener("click", () => find(false));

        let isLoaded = false;
        function updateAddressBar() {
          $back.disabled = !$webview.canGoBack();
          $forward.disabled = !$webview.canGoForward();
          $reload.classList[isLoaded ? "remove" : "add"]("hide");
          $stop.classList[isLoaded ? "add" : "remove"]("hide");
          $url.value = $webview.src;
        }

        // 注入css样式和js脚本
        $webview.addContentScripts([
          {
            name: "nw_inject",
            matches: ["<all_urls>"], // 导航到符合匹配规则的URL时注入
            css: {
              code: `
                ::-webkit-scrollbar {
                  width: 12px;
                  height: 12px;
                }
                ::-webkit-scrollbar-track {
                  background-color: #fcfcfc;
                }
                ::-webkit-scrollbar-thumb {
                  background-color: #8b8b8b;
                  border-radius: 6px;
                  border: 2px solid #fcfcfc;
                }
                ::-webkit-scrollbar-thumb:hover {
                  background-color: #636363;
                }
              `,
              // files: ["webview_inject.css"],
            },
            // world: "MAIN", // 脚本注入到真实环境，NW.js貌似不支持该特性
            // 不支持注入到真实环境，所以在contentload后通过executeScript来注入
            js: {
              // code: 'console.log('test')',
              // files: ["webview_inject.js"],
            },
            run_at: "document_start", // 在DOM加载之前注入
            all_frames: true,
          },
        ]);

        // 文档发生导航
        $webview.addEventListener("loadcommit", (e) => {
          // 只处理最外层框架
          if (e.isTopLevel) {
            isLoaded = false;
            updateAddressBar();
          }
        });

        // 开始加载
        $webview.addEventListener("loadstart", (e) => {});

        // 文档加载完成（文档内部的导航“不”会触发）
        $webview.addEventListener("contentload", (e) => {});

        // 文档加载完成（文档内部的导航“也”会触发）
        $webview.addEventListener("loadstop", (e) => {
          isLoaded = true;
          updateAddressBar();
          // 在webview中执行js脚本
          $webview.executeScript(
            {
              // 获取基本信息（图标、标题、url）
              code: `[
                {
                  favicon: document.querySelector('link[rel="shortcut icon"],link[rel="icon"]')?.href
                        || location.origin + "/favicon.ico",
                  title: document.title,
                  url: location.href,
                }
              ]`,
            },
            ([[info]]) => {
              // console.log(info);
              $favicon.src = info.favicon;
              $title.textContent = info.title;
            }
          );

          // 构建消息通道
          $webview.executeScript({
            // mainWorld: true, // 如果需要访问webview的真实上下文
            code: `
              let source;
              // 侦听来自应用的消息
              window.addEventListener("message", (event) => {
                if (event.data === "nw_init") {
                  console.log(event.data);
                  // 缓存外层窗口引用
                  source = event.source;
                  // 向外层窗口发送消息
                  source.postMessage("webview_inited", "*");
                }
              });
            `,
          });
          // 发送初始化消息（主要是为了把外层窗口的引用传给WebView）
          $webview.contentWindow.postMessage("nw_init", "*");
        });

        // 侦听（来自webview的）消息
        window.addEventListener("message", (event) => {
          console.log(event.data);
        });

        // 取消加载或加载失败
        $webview.addEventListener("loadabort", (e) => {
          isLoaded = true;
          updateAddressBar();
          e.preventDefault(); // 阻止默认行为，否则会在控制台输出一条警告信息
        });

        // 打开窗口
        $webview.addEventListener("newwindow", (e) => {
          // 在浏览器中，一般是打开一个新标签页或窗口
          // 因为本示例只有一个webview，就直接在该webview中加载了
          $webview.src = e.targetUrl;
          e.preventDefault(); // 阻止默认行为，否则会在控制台输出一条警告信息
        });

        // 自行关闭
        $webview.addEventListener("close", () => window.close());

        // 模态弹框
        $webview.addEventListener("dialog", (e) => {
          const { dialog, messageType, messageText, defaultPromptText } = e;
          switch (messageType) {
            case "alert":
              alert(messageText);
              dialog.ok();
              break;
            case "confirm":
              dialog[confirm(messageText) ? "ok" : "cancel"]();
              break;
            case "prompt":
              const result = prompt(messageText, defaultPromptText);
              dialog[typeof result === "string" ? "ok" : "cancel"](result);
              break;
          }
        });
      }
    </script>
  </body>
</html>
